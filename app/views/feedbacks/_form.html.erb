<%# å¤–æ ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ %>
<div style="max-width: 650px; margin: 60px auto; padding: 50px 60px; background-color: #ffffff; border: 1px solid #e5e5e5; border-radius: 2px; font-family: 'Helvetica Neue', 'Helvetica', 'Hiragino Sans', sans-serif; color: #1a1a1a; line-height: 1.6; letter-spacing: 0.02em;">

  <%# ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ† %>
  <h2 style="font-size: 20px; font-weight: 300; text-align: center; margin-bottom: 50px; letter-spacing: 0.15em; color: #1a1a1a; text-transform: uppercase;">
    <%= action_name == 'new' ? 'New Feedback' : 'Edit Feedback' %>
  </h2>
  
  <%= form_with(model: @feedback, local: true) do |f| %>
    <%# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º %>
    <% if @feedback.errors.any? %>
      <div style="color: red; font-size: 12px; margin-bottom: 20px; padding: 10px; border: 1px solid red;">
        <p><%= @feedback.errors.count %>ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ï¼š</p>
        <ul>
          <% @feedback.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    
    <%# ç”Ÿå¾’é¸æŠ %>
    <div style="margin-bottom: 15px;">
      <%= f.label :student_id, style: "display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;" do %>
        ç”Ÿå¾’ã‚’é¸æŠ <span style="color: #d1d1d1; margin-left: 5px;">*</span>
      <% end %>

      <% if current_user.student? %>
        <%= f.collection_select :student_id, @students, :id, :name, {}, { disabled: true, style: "font-size: 12px; width: 100%; #{'background: #f5f5f5;' if current_user.student?}" } %>
        <%= f.hidden_field :student_id %>
      <% else %>
        <%= f.collection_select :student_id, @students, :id, :name, { prompt: "é¸æŠã—ã¦ãã ã•ã„" }, { style: "font-size: 12px; width: 100%; #{'background: #f5f5f5;' if current_user.student?}" } %>
      <% end %>
    </div>

    <%# ãƒ¬ãƒƒã‚¹ãƒ³æ—¥ %>
    <div style="margin-bottom: 15px;">
      <%= f.label :lesson_date, style: "display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;" do%>
        ãƒ¬ãƒƒã‚¹ãƒ³æ—¥ <span style="color: #d1d1d1; margin-left: 5px;">*</span>
      <% end %>
      <%= f.date_field :lesson_date, readonly: current_user.student?, 
          style: "font-size: 12px; width: 100%; #{'background: #f5f5f5;' if current_user.student?}" %>
    </div>

    <%# è¬›ç¿’åï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ %>
    <div style="margin-bottom: 25px;">
      <%= f.label :title, style: "display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;" do%>
        è¬›ç¿’å <span style="color: #d1d1d1; margin-left: 5px;">*</span>
      <% end %>
      <%= f.text_field :title, readonly: current_user.student?, placeholder: "ä¾‹ï¼šå¤æœŸè¬›ç¿’ ç¬¬1å› / TOEICå¯¾ç­–", style: "width: 100%; padding: 12px; border: 1px solid #e5e5e5; border-radius: 0; background: #fff; font-size: 12px; color: #1a1a1a; outline: none;" %>
    </div>

    <%# è¬›ç¿’æ™‚é–“ %>
    <div style="margin-bottom: 25px;">
      <%= f.label :time, "è¬›ç¿’æ™‚é–“", style: "display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;" %>
      <div style="display: flex; align-items: center; gap: 15px;">
        <%# HOURã®å…¥åŠ› %>
        <div style="display: flex; align-items: center; gap: 8px;">
          <%= f.number_field :hour, readonly: current_user.student?, placeholder: "0", min: 0, style: "width: 70px; padding: 12px; border: 1px solid #e5e5e5; border-radius: 0; background: #fff; font-size: 12px; color: #1a1a1a; outline: none;" %>
          <span style="font-size: 11px; color: #999;">HR</span>
        </div>

        <%# MINUTEã®å…¥åŠ› %>
        <div style="display: flex; align-items: center; gap: 8px;">
          <%= f.number_field :minute, readonly: current_user.student?, placeholder: "0", min: 0, max: 59, style: "width: 70px; padding: 12px; border: 1px solid #e5e5e5; border-radius: 0; background: #fff; font-size: 12px; color: #1a1a1a; outline: none;" %>
          <span style="font-size: 11px; color: #999;">MIN</span>
        </div>
      </div>
    </div>

    <%# ç†è§£åº¦ï¼ˆæ˜Ÿè©•ä¾¡ï¼‰ %>
    <div style="margin-bottom: 15px;">
      <%= f.label :rating, "æœ¬æ—¥ã®ç†è§£åº¦", style: "display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;"  %>
      <div style="font-size: 20px; color: #030200;">
        <%= f.select :rating, [["â˜…â˜…â˜…â˜…â˜…", 5], ["â˜…â˜…â˜…â˜…", 4], ["â˜…â˜…â˜…", 3], ["â˜…â˜…", 2], ["â˜…", 1]], { prompt: "è©•ä¾¡ã‚’é¸æŠ" }, { disabled: current_user.student?, style: "width: 100%; padding: 12px; border: 1px solid #e5e5e5; border-radius: 0; background: #fff; font-size: 12px; -webkit-appearance: none;" } %>
      </div>
    </div>

    <%# é …ç›®åˆ¥è©•ä¾¡ï¼ˆâ—‹â–³Ã—ï¼‰ %>
    <div style="margin: 40px 0; padding: 25px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee;">
      <%= f.label :check_items, "â— é …ç›®åˆ¥ãƒã‚§ãƒƒã‚¯", style: "display: block; font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;" %>
      <span style="font-size: 10px; color: #666; width: 100%;">å®šå‹æ–‡ã‚’æŒ¿å…¥:</span>

      <% if current_user.teacher? %>
        <div style="margin-bottom: 10px; display: flex; gap: 10px;">
          <button type="button" class="template-btn" data-items='["å®¿é¡Œãƒã‚§ãƒƒã‚¯", "å‰å›ã®å¾©ç¿’"]' style="background: transparent; border: 1px solid #e5e5e5; color: #1a1a1a; padding: 6px 12px; border-radius: 0; font-size: 10px; letter-spacing: 0.05em; cursor: pointer;">ãƒ™ãƒ¼ã‚·ãƒƒã‚¯</button>
          <button type="button" class="template-btn" data-items='["ãƒ†ã‚­ã‚¹ãƒˆ", "æ–‡æ³•è¬›ç¾©", "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°"]' style="background: transparent; border: 1px solid #e5e5e5; color: #1a1a1a; padding: 6px 12px; border-radius: 0; font-size: 10px; letter-spacing: 0.05em; cursor: pointer;">åº§å­¦</button>
        </div>
      <% end %>

      <div style="background: #f1f5f9; padding: 10px; border-radius: 0px; font-size: 12px; margin-bottom: 15px; color: #475569;">
        <%= render 'rating_legend' %>
      </div>

      <h3 style="font-size: 13px; font-weight: 300; letter-spacing: 0.1em; margin-bottom: 20px; color: #1a1a1a; display: flex; justify-content: space-between; align-items: center;">
        Add Button
        <% if current_user.teacher? %> <%# ğŸ’¡ è¬›å¸«ã®æ™‚ã ã‘è¡¨ç¤ºï¼ %>
        <button type="button" id="add-item-button" style="background: none; border: 1px solid #1a1a1a; color: #1a1a1a; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">+</button>
        <% end %>
      </h3>
      
      <div id="check-items-container">
        <%= f.fields_for :check_items do |item_f| %>
          <div class="check-item-row" style="display: flex; gap: 10px; margin-bottom: 12px; align-items: center;">
            <%# ã‚¿ã‚¤ãƒ å…¥åŠ›æ¬„ %>
            <%= item_f.text_field :timestamp, placeholder: "00:00", style: "width: 60px; padding: 10px; border: 1px solid #e5e5e5; font-size: 12px; text-align: center;" %>
            <%= item_f.text_field :name, readonly: current_user.student?, placeholder: "é …ç›®å (ä¾‹: ã‚ã„ã•ã¤)", style: "flex: 2; padding: 12px; border: 1px solid #e5e5e5; border-radius: 0; background: #fff; font-size: 12px;"  %>
            <%= item_f.select :result, [["â—", "â—"], ["â—‹", "â—‹"], ["â–³", "â–³"], ["Ã—", "Ã—"]], { prompt: "è©•ä¾¡" }, { disabled: current_user.student?, style: "flex: 1; padding: 12px; border: 1px solid #e5e5e5; border-radius: 0; background: #fff; font-size: 12px;" } %>
          </div>
        <% end %>
      </div>

      <template id="item-template">
        <div class="check-item-row" style="display: flex; gap: 10px; margin-bottom: 12px; align-items: center;">
          <input type="text" name="feedback[check_items_attributes][NEW_RECORD][timestamp]" placeholder="00:00" style="width: 60px; padding: 10px; border: 1px solid #e5e5e5; font-size: 12px; text-align: center;">
          <input type="text" name="feedback[check_items_attributes][NEW_RECORD][name]" placeholder="é …ç›®å (ä¾‹: ã‚ã„ã•ã¤)" style="flex: 2; padding: 10px; border: 1px solid #e5e5e5; border-radius: 0px; font-size: 12px;">
          <select name="feedback[check_items_attributes][NEW_RECORD][result]" style="flex: 1; padding: 10px; border: 1px solid #e5e5e5; border-radius: 0px; font-size: 12px;">
            <option value="">è©•ä¾¡</option>
            <option value="â—">â—</option>
            <option value="â—‹">â—‹</option>
            <option value="â–³">â–³</option>
            <option value="Ã—">Ã—</option>
          </select>
            <% if current_user.teacher? %>
            <button type="button" class="remove-item-button" style="background: none; border: none; color: #999; cursor: pointer; font-size: 18px; font-weight: 200;">Ã—</button>
            <% end %>
        </div>
      </template>
    </div>

    <%# ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒœã‚¿ãƒ³ %>
    <%= f.label :content_label, "â— å…¨ä½“ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯", style: "display: block; font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px;" %>
    <% if current_user.teacher? %>
      <div style="margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
        <span style="font-size: 10px; color: #666; width: 100%;">å®šå‹æ–‡ã‚’æŒ¿å…¥:</span>
        <button type="button" class="phrase-btn" data-text="ä»Šæ—¥ã‚‚ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ãã¾ã—ãŸã­ï¼ã“ã®èª¿å­ã§æ¬¡å›ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†âœ¨" style="background: transparent; border: 1px solid #e5e5e5; color: #666; padding: 6px 12px; border-radius: 0; font-size: 10px; cursor: pointer;">ğŸ˜Š ã†ã¾ãã§ããŸ</button>
        <button type="button" class="phrase-btn" data-text="ãƒ¬ãƒƒã‚¹ãƒ³ä¸­ã«ä¼ãˆãŸå†…å®¹ã‚’æŒ¯ã‚Šè¿”ã‚Šã€åå¾©ç·´ç¿’ã—ãªãŒã‚‰è‡ªåˆ†ã®ã‚¹ã‚­ãƒ«ã«ç¹‹ã’ã¾ã—ã‚‡ã†ï¼" style="background: transparent; border: 1px solid #e5e5e5; color: #666; padding: 6px 12px; border-radius: 0; font-size: 10px; cursor: pointer;">ğŸ’ª å¾©ç¿’é ‘å¼µã‚ã†</button>
        <button type="button" class="phrase-btn" data-text="æ¬¡å›ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¯ã€ ã€ã®äºˆå®šã§ã™ã€‚ä½™è£•ãŒã‚ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆã«ç›®ã‚’é€šã—ã¦ãŠã„ã¦ãã ã•ã„ã­ï¼" style="background: transparent; border: 1px solid #e5e5e5; color: #666; padding: 6px 12px; border-radius: 0; font-size: 10px; cursor: pointer;">ğŸ“– æ¬¡å›ã®äºˆå‘Š</button>
      </div>
    <% end %>

    <%# å…¨ä½“ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ %>
    <div style="margin-bottom: 20px;">
        <%= f.text_area :content, id: "feedback-content", readonly: current_user.student?, 
            style: "padding: 15px; font-size: 11px; margin-bottom: 20px; color: #888; border: 1px solid #f0f0f0; line-height: 1.8; letter-spacing: 0.02em;width: 100%; #{'background: #f5f5f5;' if current_user.student?}" %>
      </div>
      
    <%= f.submit f.object.new_record? ? "CREATE FEEDBACK" : "UPDATE FEEDBACK", style: "width: 100%; padding: 16px; background-color: #1a1a1a; color: #fff; border: none; border-radius: 0; font-weight: 300; font-size: 12px; letter-spacing: 0.2em; cursor: pointer; margin-top: 30px;" %>
  <% end %> 
</div> 

<%# JavaScript ã¯ãƒ•ã‚©ãƒ¼ãƒ ã®å¤–éƒ¨ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã®ä¸‹ï¼‰ã«é…ç½® %>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('check-items-container');
    const addButton = document.getElementById('add-item-button');
    const template = document.getElementById('item-template');
    const templateBtns = document.querySelectorAll('.template-btn');

    addButton.addEventListener('click', () => {
      let content = template.innerHTML;
      const newId = new Date().getTime();
      content = content.replace(/NEW_RECORD/g, newId);
      container.insertAdjacentHTML('beforeend', content);
    });

    container.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-item-button')) {
        const row = e.target.closest('.check-item-row');
        row.remove();
      }
    });

    templateBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const items = JSON.parse(btn.dataset.items);
        items.forEach(itemName => {
          let content = template.innerHTML;
          const newId = new Date().getTime() + Math.random();
          content = content.replace(/NEW_RECORD/g, newId);
          container.insertAdjacentHTML('beforeend', content);

          const lastRow = container.lastElementChild;
          const input = lastRow.querySelector('[name*="[name]"]');
          if (input) input.value = itemName;
        });
      });
    });

    const phraseBtns = document.querySelectorAll('.phrase-btn');
    const contentArea = document.getElementById('feedback-content');
    phraseBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const text = btn.dataset.text;
        contentArea.value = contentArea.value ? contentArea.value + "\n" + text : text;
        contentArea.focus();
      });
    });
  });
</script>
